# SGN — Melhorias Técnicas e Roadmap de Implementação

Status atual: MVP completo e operacional (frontend Next.js 15 + Supabase + N8N). Documento para acompanhar execução das melhorias até nível produção-empresa com foco em performance, escala, confiabilidade, a11y/SEO e DX.

**NOVA PRIORIDADE ESTRATÉGICA:** Análise de Conformidade Corporativa - transformação de MVP informativo para solução empresarial de alto valor.

---

## 🚀 PRIORIDADE MÁXIMA: Conformidade Corporativa (0-60 dias)

### Sistema Multi-tenant e Gestão de Empresas
- [ ] **Arquitetura Multi-tenant**
  - [ ] Criar tabela `empresas` com isolamento de dados
  - [ ] Implementar RLS (Row Level Security) por tenant
  - [ ] Sistema de autenticação corporativa
  - [ ] Middleware de identificação de tenant

- [ ] **Gestão Documental Corporativa**
  - [ ] Sistema de upload para Supabase Storage
  - [ ] Integração OCR/parsing (PDF, DOC, DOCX)
  - [ ] Extração de texto com bibliotecas especializadas
  - [ ] Versionamento de documentos empresariais
  - [ ] Metadados estruturados (JSONB)

### Engine de Análise de Conformidade
- [ ] **Processamento de Documentos**
  - [ ] Worker/Queue para processamento assíncrono
  - [ ] Chunking inteligente de documentos grandes
  - [ ] Indexação para busca semântica
  - [ ] Cache de análises para otimização

- [ ] **IA para Análise de Conformidade**
  - [ ] Integração LLM para comparação semântica
  - [ ] Prompt engineering para análise normativa
  - [ ] Sistema de scoring de conformidade (0-100)
  - [ ] Identificação automática de gaps
  - [ ] Geração de planos de ação

### Performance para Escala Corporativa
- [ ] **Otimizações de IA**
  - [ ] Cache Redis para análises repetidas
  - [ ] Processamento em lotes (batch processing)
  - [ ] Rate limiting específico para análises
  - [ ] Monitoramento de custos de LLM

- [ ] **Storage e Backup**
  - [ ] Estratégia de backup corporativo
  - [ ] Compressão de documentos antigos
  - [ ] CDN para assets corporativos
  - [ ] Políticas de retenção de dados

---

## 1) Plano Prioritário Base (30-60 dias)
- [ ] Ordenação e paginação no banco (evitar sort pós-paginação)
  - [ ] Criar coluna `nr_num` (inteiro) derivada de `codigo` (ex.: "NR-17" → 17)
  - [ ] Popular `nr_num` para registros existentes
  - [ ] Criar índice btree em `nr_num` e `created_at`
  - [ ] Ajustar `GET /api/normas` para `.order("nr_num", { ascending: true })` antes de `.range()`
- [ ] Cache e fetch previsíveis
  - [ ] Usar URLs relativas no `Dashboard` (`/api/...`) e remover `no-store`
  - [ ] Definir revalidação curta (ex.: 60s) para stats/listagens
  - [ ] Ativar prefetch de links de navegação
- [ ] Rate limiting distribuído
  - [ ] Migrar de Map em memória para Redis (ou Supabase KV)
  - [ ] Chavear por `X-Forwarded-For` com fallback controlado
  - [ ] Aplicar em `search`, `export` e **análises de conformidade**
- [ ] Tipagem e validação expandida
  - [ ] Criar tipos `Empresa`, `DocumentoEmpresa`, `AnaliseConformidade`
  - [ ] Validar upload de arquivos com Zod
  - [ ] Tipos para respostas de conformidade

## 2) Segurança Corporativa (Crítico - 30-45 dias)
- [ ] **Proteção de Dados Empresariais**
  - [ ] Criptografia em repouso para documentos sensíveis
  - [ ] Logs de auditoria para acessos a documentos
  - [ ] Políticas de retenção por empresa
  - [ ] Backup com criptografia end-to-end

- [ ] **Controle de Acesso Avançado**
  - [ ] RBAC (Role-Based Access Control) corporativo
  - [ ] Permissões granulares por documento
  - [ ] Sessões seguras com refresh tokens
  - [ ] Two-factor authentication para administradores

- [ ] **Compliance e Auditoria**
  - [ ] Trail de auditoria completo
  - [ ] LGPD compliance para dados empresariais
  - [ ] Relatórios de acesso para compliance
  - [ ] Políticas de privacidade por tenant

## 3) Base de Escala e Confiabilidade (60-90 dias)
- [ ] Busca escalável (Postgres FTS) + **Busca Corporativa**
  - [ ] Criar coluna `search_vector` para normas e documentos
  - [ ] Índice GIN em `search_vector` para ambas tabelas
  - [ ] Busca semântica em documentos empresariais
  - [ ] Ranking por relevância corporativa
- [ ] Exportação robusta + **Relatórios Corporativos**
  - [ ] CSV/Excel com dados de conformidade
  - [ ] Relatórios executivos em PDF
  - [ ] Agendamento de relatórios automáticos
  - [ ] Templates personalizáveis por empresa
- [ ] Observabilidade corporativa
  - [ ] Métricas de uso por empresa
  - [ ] Alertas de performance para análises
  - [ ] Dashboard de health check por tenant

## 4) Experiência Corporativa e Performance
- [ ] **Dashboard Executivo**
  - [ ] Visualizações específicas para compliance
  - [ ] Gráficos de evolução de conformidade
  - [ ] Alertas visuais para prazos críticos
  - [ ] Drill-down em análises detalhadas

- [ ] **Interface de Gestão Documental**
  - [ ] Upload drag-and-drop com preview
  - [ ] Categorização visual de documentos
  - [ ] Timeline de análises realizadas
  - [ ] Comparações side-by-side

- [ ] **Performance para Volume Corporativo**
  - [ ] Virtualização de listas de documentos
  - [ ] Lazy loading de análises pesadas
  - [ ] Prefetch inteligente baseado em padrões de uso
  - [ ] Compression de responses para grandes datasets

---

## Detalhamento Técnico para Conformidade Corporativa

### A. Arquitetura Multi-tenant
```sql
-- Novas tabelas essenciais
CREATE TABLE empresas (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  nome TEXT NOT NULL,
  cnpj TEXT UNIQUE,
  setor TEXT,
  porte TEXT CHECK (porte IN ('pequeno', 'medio', 'grande')),
  configuracoes JSONB DEFAULT '{}',
  ativo BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE documentos_empresa (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  empresa_id UUID REFERENCES empresas(id) ON DELETE CASCADE,
  nome_arquivo TEXT NOT NULL,
  tipo_documento TEXT CHECK (tipo_documento IN ('manual', 'procedimento', 'treinamento', 'politica')),
  conteudo_extraido TEXT,
  metadados JSONB DEFAULT '{}',
  url_storage TEXT NOT NULL,
  versao INTEGER DEFAULT 1,
  search_vector tsvector GENERATED ALWAYS AS (to_tsvector('portuguese', nome_arquivo || ' ' || COALESCE(conteudo_extraido, ''))) STORED,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE analises_conformidade (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  empresa_id UUID REFERENCES empresas(id) ON DELETE CASCADE,
  norma_id UUID REFERENCES normas(id),
  documento_id UUID REFERENCES documentos_empresa(id),
  status_conformidade TEXT CHECK (status_conformidade IN ('conforme', 'nao_conforme', 'parcial', 'nao_aplicavel')),
  lacunas_identificadas TEXT[],
  acoes_recomendadas TEXT[],
  score_conformidade INTEGER CHECK (score_conformidade >= 0 AND score_conformidade <= 100),
  observacoes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Índices para performance
CREATE INDEX idx_documentos_empresa_search ON documentos_empresa USING GIN(search_vector);
CREATE INDEX idx_analises_empresa_norma ON analises_conformidade(empresa_id, norma_id);
CREATE INDEX idx_analises_score ON analises_conformidade(score_conformidade DESC);
```

### B. APIs para Conformidade Corporativa
- [ ] `POST /api/empresas` - Cadastro de empresas
- [ ] `POST /api/empresas/[id]/documentos` - Upload de documentos
- [ ] `POST /api/conformidade/analisar` - Trigger análise de conformidade
- [ ] `GET /api/conformidade/dashboard/[empresaId]` - Dashboard executivo
- [ ] `GET /api/conformidade/relatorios/[empresaId]` - Relatórios personalizados

### C. Worker de Processamento
```typescript
// Worker para análise assíncrona
interface ConformidadeJob {
  empresaId: string;
  documentoId: string;
  normaIds: string[];
  prioridade: 'alta' | 'media' | 'baixa';
}

// Queue Redis para processamento
// Integração com LLM para análise semântica
// Sistema de retry para falhas
// Notificações de conclusão
```

---

## Critérios de Aceite Expandidos (KPIs)

### Performance Base
- [ ] Lighthouse (mobile): Performance ≥ 95, Acessibilidade ≥ 95, SEO ≥ 95
- [ ] API p95 < 300 ms nas principais rotas
- [ ] Erros 5xx < 0,5% das requisições

### Performance Corporativa
- [ ] Upload de documentos < 30s para arquivos até 10MB
- [ ] Análise de conformidade < 2 minutos para documentos médios
- [ ] Dashboard corporativo carrega < 1s
- [ ] Suporte a 1000+ documentos por empresa

### Segurança e Compliance
- [ ] Isolamento 100% efetivo entre tenants
- [ ] Logs de auditoria para 100% das operações sensíveis
- [ ] Backup recovery time < 4 horas
- [ ] Zero vazamentos de dados entre empresas

---

## Referências de Código Expandidas
### Arquivos Existentes
- `frontend/src/app/api/normas/route.ts`
- `frontend/src/app/api/search/route.ts`
- `frontend/src/app/api/export/route.ts`

### Novos Arquivos para Implementar
- `frontend/src/app/api/empresas/route.ts`
- `frontend/src/app/api/empresas/[id]/documentos/route.ts`
- `frontend/src/app/api/conformidade/analisar/route.ts`
- `frontend/src/app/api/conformidade/dashboard/[empresaId]/route.ts`
- `frontend/src/workers/conformidade-processor.ts`
- `frontend/src/types/conformidade.ts`
- `frontend/src/app/empresas/[id]/dashboard/page.tsx`

**TRANSFORMAÇÃO ESTRATÉGICA COMPLETA:** De MVP informativo para plataforma corporativa de compliance automatizada.


