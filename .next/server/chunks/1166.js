exports.id=1166,exports.ids=[1166],exports.modules={7367:(a,b,c)=>{"use strict";c.d(b,{$y:()=>h,WX:()=>g,sv:()=>f});var d=c(10641),e=c(93616);async function f(a,b){try{let c=await b.json();try{let b=a.parse(c);return{success:!0,data:b}}catch(a){if(a instanceof e.GaX){let b=a.errors.map(a=>`${a.path.join(".")}: ${a.message}`).join(", ");return{success:!1,error:`Dados inv\xe1lidos: ${b}`}}return{success:!1,error:"Erro de valida\xe7\xe3o desconhecido"}}}catch(a){return{success:!1,error:"Body da requisi\xe7\xe3o inv\xe1lido ou ausente"}}}function g(a,b=400,c){return d.NextResponse.json({success:!1,error:a,details:c,timestamp:new Date().toISOString()},{status:b})}function h(a,b,c=200){return d.NextResponse.json({success:!0,data:a,message:b,timestamp:new Date().toISOString()},{status:c})}},64562:(a,b,c)=>{"use strict";c.r(b),c.d(b,{GET:()=>u,GET_STATS:()=>w,POST:()=>v,POST_TEST:()=>x,handleSecurityRequest:()=>y});var d=c(10641),e=c(72626),f=c(89093);let g={production:{origin:["https://sgn.vercel.app","https://sgn-staging.vercel.app","https://sgn-sistema-gestao-normativa.vercel.app"],methods:["GET","POST","PUT","DELETE","OPTIONS"],allowedHeaders:["Content-Type","Authorization","X-Correlation-ID"],credentials:!0}},h={production:{"default-src":["'self'"],"script-src":["'self'","'unsafe-inline'"],"style-src":["'self'","'unsafe-inline'"],"img-src":["'self'","data:","https:"],"font-src":["'self'","https:"],"connect-src":["'self'","https:"],"frame-src":["'none'"],"object-src":["'none'"],"base-uri":["'self'"],"form-action":["'self'"]}},i={"X-Frame-Options":"DENY","X-Content-Type-Options":"nosniff","X-XSS-Protection":"1; mode=block","Referrer-Policy":"strict-origin-when-cross-origin","Permissions-Policy":"camera=(), microphone=(), geolocation=(), payment=()","Strict-Transport-Security":"max-age=31536000; includeSubDomains; preload","Cross-Origin-Embedder-Policy":"require-corp","Cross-Origin-Opener-Policy":"same-origin","Cross-Origin-Resource-Policy":"same-origin"};function j(){return{environment:"production",cors:g.production,csp:h.production,securityHeaders:i,isProduction:!0}}function k(){let a=j(),b=[];return 0===a.cors.origin.length&&b.push("CORS origins n\xe3o configurados"),0===Object.keys(a.csp).length&&b.push("CSP n\xe3o configurado"),0===Object.keys(a.securityHeaders).length&&b.push("Headers de seguran\xe7a n\xe3o configurados"),{valid:0===b.length,issues:b,config:a}}var l=c(96378);let m={general:{windowMs:9e5,max:100,message:"Muitas requisi\xe7\xf5es deste IP, tente novamente em 15 minutos"},api:{windowMs:6e4,max:30,message:"Muitas requisi\xe7\xf5es de API deste IP, tente novamente em 1 minuto"},ia:{windowMs:3e5,max:5,message:"Limite de an\xe1lises de IA excedido, tente novamente em 5 minutos"},upload:{windowMs:6e5,max:10,message:"Limite de uploads excedido, tente novamente em 10 minutos"},auth:{windowMs:9e5,max:5,message:"Muitas tentativas de autentica\xe7\xe3o, tente novamente em 15 minutos"}};class n{constructor(){this.initializeCache()}async initializeCache(){try{this.cacheManager=await (0,l.mZ)()}catch(a){console.error("Erro ao inicializar cache para rate limiting:",a)}}generateKey(a,b){let c=a.headers.get("x-forwarded-for")||a.headers.get("x-real-ip")||a.headers.get("cf-connecting-ip")||"unknown",d=a.headers.get("user-agent")||"unknown";return(0,f.wh)(a),`${b}:${c}:${Buffer.from(d).toString("base64").slice(0,20)}`}async checkLimit(a,b){try{if(!this.cacheManager)return{allowed:!0,remaining:b.max,resetTime:Date.now()+b.windowMs,totalHits:0};let c=this.generateKey(a,"rate_limit"),d=Date.now(),e=d-b.windowMs,f=(await this.cacheManager.get(c)||[]).filter(a=>a>e),g=f.length<b.max;g&&(f.push(d),await this.cacheManager.set(c,f,Math.ceil(b.windowMs/1e3)));let h=(f.length>0?Math.min(...f):d)+b.windowMs;return{allowed:g,remaining:Math.max(0,b.max-f.length),resetTime:h,totalHits:f.length}}catch(a){return console.error("Erro no rate limiting:",a),{allowed:!0,remaining:b.max,resetTime:Date.now()+b.windowMs,totalHits:0}}}async logRateLimitAttempt(a,b,c){let d=(0,f.kz)(a);c.allowed||(0,e.logSecurity)("rate_limit_exceeded","medium",{...d,rateLimitConfig:b,totalHits:c.totalHits,remaining:c.remaining,resetTime:c.resetTime})}}let o=null;async function p(){return o||(o=new n),o}function q(a){return function(b){return async(c,...e)=>{let f=await p(),g=await f.checkLimit(c,a);if(await f.logRateLimitAttempt(c,a,g),!g.allowed){let b=d.NextResponse.json({success:!1,message:a.message,error:"RATE_LIMIT_EXCEEDED",retryAfter:Math.ceil((g.resetTime-Date.now())/1e3),timestamp:new Date().toISOString()},{status:429});return b.headers.set("X-RateLimit-Limit",String(a.max)),b.headers.set("X-RateLimit-Remaining",String(g.remaining)),b.headers.set("X-RateLimit-Reset",String(Math.ceil(g.resetTime/1e3))),b.headers.set("Retry-After",String(Math.ceil((g.resetTime-Date.now())/1e3))),b}let h=await b(c,...e);return h.headers.set("X-RateLimit-Limit",String(a.max)),h.headers.set("X-RateLimit-Remaining",String(g.remaining)),h.headers.set("X-RateLimit-Reset",String(Math.ceil(g.resetTime/1e3))),h}}}async function r(a,b="rate_limit"){try{let c=await (0,l.mZ)(),d=`${b}:${a}:*`;await c.deletePattern(d),console.log(`Rate limit resetado para IP: ${a}`)}catch(a){console.error("Erro ao resetar rate limit:",a)}}async function s(){try{let a=await (0,l.mZ)(),b=await a.redis.keys("rate_limit:*"),c={totalKeys:b.length,activeLimits:0,blockedIPs:0};for(let d of b){let b=await a.get(d);if(b&&b.length>0){c.activeLimits++;let a=Date.now();b.filter(b=>b>a-9e5).length>=100&&c.blockedIPs++}}return c}catch(a){return console.error("Erro ao obter estat\xedsticas de rate limiting:",a),{totalKeys:0,activeLimits:0,blockedIPs:0}}}q(m.general),q(m.api),q(m.ia),q(m.upload),q(m.auth);var t=c(7367);async function u(a){let b=(0,f.wh)(a),c=(0,f.kz)(a);try{e.apiLogger.info({...c,event:"security_config_request"},"Solicita\xe7\xe3o de configura\xe7\xe3o de seguran\xe7a");let a=j(),d=k();(0,e.logAudit)("security_config_viewed",void 0,c);let g=(0,t.$y)({config:a,validation:d,timestamp:new Date().toISOString()},"Configura\xe7\xe3o de seguran\xe7a obtida com sucesso",200);return(0,f.ze)(g,b)}catch(d){e.apiLogger.error({...c,event:"security_config_error",error:d instanceof Error?d.message:"Erro desconhecido"},"Erro ao obter configura\xe7\xe3o de seguran\xe7a");let a=(0,t.WX)("Erro ao obter configura\xe7\xe3o de seguran\xe7a",500,d instanceof Error?d.message:"Erro desconhecido");return(0,f.ze)(a,b)}}async function v(a){let b=(0,f.wh)(a),c=(0,f.kz)(a);try{let{ip:d,prefix:g}=await a.json();if(!d)return(0,t.WX)("IP \xe9 obrigat\xf3rio",400);e.apiLogger.info({...c,event:"rate_limit_reset_request",ip:d,prefix:g},"Solicita\xe7\xe3o de reset de rate limit"),await r(d,g||"rate_limit"),(0,e.logSecurity)("rate_limit_reset","medium",{...c,ip:d,prefix:g});let h=(0,t.$y)({ip:d,prefix:g||"rate_limit",resetAt:new Date().toISOString()},"Rate limit resetado com sucesso",200);return(0,f.ze)(h,b)}catch(d){e.apiLogger.error({...c,event:"rate_limit_reset_error",error:d instanceof Error?d.message:"Erro desconhecido"},"Erro ao resetar rate limit");let a=(0,t.WX)("Erro ao resetar rate limit",500,d instanceof Error?d.message:"Erro desconhecido");return(0,f.ze)(a,b)}}async function w(a){let b=(0,f.wh)(a),c=(0,f.kz)(a);try{e.apiLogger.info({...c,event:"security_stats_request"},"Solicita\xe7\xe3o de estat\xedsticas de seguran\xe7a");let a=await s(),d=j(),g={rateLimit:a,security:{environment:d.environment,corsOrigins:d.cors.origin.length,cspDirectives:Object.keys(d.csp).length,securityHeaders:Object.keys(d.securityHeaders).length},timestamp:new Date().toISOString()};(0,e.logAudit)("security_stats_viewed",void 0,c);let h=(0,t.$y)(g,"Estat\xedsticas de seguran\xe7a obtidas com sucesso",200);return(0,f.ze)(h,b)}catch(d){e.apiLogger.error({...c,event:"security_stats_error",error:d instanceof Error?d.message:"Erro desconhecido"},"Erro ao obter estat\xedsticas de seguran\xe7a");let a=(0,t.WX)("Erro ao obter estat\xedsticas de seguran\xe7a",500,d instanceof Error?d.message:"Erro desconhecido");return(0,f.ze)(a,b)}}async function x(a){let b=(0,f.wh)(a),c=(0,f.kz)(a);try{let{testType:d}=await a.json();e.apiLogger.info({...c,event:"security_test_request",testType:d},"Solicita\xe7\xe3o de teste de seguran\xe7a");let g={timestamp:new Date().toISOString(),tests:{}};if(!d||"cors"===d){let a={allowedOrigins:j().cors.origin.length,methods:j().cors.methods.length,headers:j().cors.allowedHeaders.length,credentials:j().cors.credentials};g.tests.cors=a}if(!d||"csp"===d){let a={directives:Object.keys(j().csp).length,hasDefaultSrc:"default-src"in j().csp,hasScriptSrc:"script-src"in j().csp,hasStyleSrc:"style-src"in j().csp};g.tests.csp=a}if(!d||"rateLimit"===d){let a=await s();g.tests.rateLimit=a}if(!d||"headers"===d){let a={totalHeaders:Object.keys(j().securityHeaders).length,hasFrameOptions:"X-Frame-Options"in j().securityHeaders,hasContentTypeOptions:"X-Content-Type-Options"in j().securityHeaders,hasXssProtection:"X-XSS-Protection"in j().securityHeaders};g.tests.headers=a}g.validation=k(),(0,e.logAudit)("security_test_executed",void 0,{...c,testType:d,results:g});let h=(0,t.$y)(g,"Teste de seguran\xe7a executado com sucesso",200);return(0,f.ze)(h,b)}catch(d){e.apiLogger.error({...c,event:"security_test_error",error:d instanceof Error?d.message:"Erro desconhecido"},"Erro ao executar teste de seguran\xe7a");let a=(0,t.WX)("Erro ao executar teste de seguran\xe7a",500,d instanceof Error?d.message:"Erro desconhecido");return(0,f.ze)(a,b)}}async function y(a){let b=new URL(a.url).pathname;return b.endsWith("/config")?u(a):b.endsWith("/stats")?w(a):b.endsWith("/test")?x(a):b.endsWith("/rate-limit/reset")?v(a):(0,t.WX)("Endpoint n\xe3o encontrado",404)}},72626:()=>{},78335:()=>{},89093:(a,b,c)=>{"use strict";c.d(b,{kz:()=>g,wh:()=>e,ze:()=>f});var d=c(55511);function e(a){return a.headers.get("x-correlation-id")||(0,d.randomUUID)()}function f(a,b){return a.headers.set("x-correlation-id",b),a}function g(a,b){return{...function(a){let b=e(a);return{correlationId:b,userAgent:a.headers.get("user-agent")||"unknown",ip:a.headers.get("x-forwarded-for")||a.headers.get("x-real-ip")||"unknown",method:a.method,url:a.url,timestamp:new Date().toISOString()}}(a),...b}}c(10641)},96378:(a,b,c)=>{"use strict";c.d(b,{U_:()=>n,_l:()=>m,mZ:()=>l});var d=c(50453),e=c.n(d),f=c(72626);let g={host:process.env.REDIS_HOST||"localhost",port:parseInt(process.env.REDIS_PORT||"6379"),password:process.env.REDIS_PASSWORD,db:parseInt(process.env.REDIS_DB||"0"),retryDelayOnFailover:100,maxRetriesPerRequest:3,lazyConnect:!0,keepAlive:3e4,connectTimeout:1e4,commandTimeout:5e3,retryDelayOnClusterDown:300,enableOfflineQueue:!1,maxLoadingTimeout:1e4},h=null;async function i(){if(h&&"ready"===h.status)return h;try{return(h=new(e())(g)).on("connect",()=>{console.log("✅ Redis conectado com sucesso")}),h.on("error",a=>{(0,f.logError)(a,{context:"redis-connection"}),console.error("❌ Erro na conex\xe3o Redis:",a.message)}),h.on("close",()=>{console.log("\uD83D\uDD0C Conex\xe3o Redis fechada")}),h.on("reconnecting",()=>{console.log("\uD83D\uDD04 Reconectando ao Redis...")}),await h.connect(),h}catch(a){throw(0,f.logError)(a,{context:"redis-connection"}),console.error("❌ Falha ao conectar Redis:",a),a}}class j{constructor(a){this.redis=a}async set(a,b,c=3600){try{let d=JSON.stringify(b);await this.redis.setex(a,c,d)}catch(b){(0,f.logError)(b,{context:"cache-set",key:a})}}async get(a,b){try{let c=await this.redis.get(a);if(c)return JSON.parse(c);return b||null}catch(c){return(0,f.logError)(c,{context:"cache-get",key:a}),b||null}}async delete(a){try{await this.redis.del(a)}catch(b){(0,f.logError)(b,{context:"cache-delete",key:a})}}async deletePattern(a){try{let b=await this.redis.keys(a);b.length>0&&await this.redis.del(...b)}catch(b){(0,f.logError)(b,{context:"cache-delete-pattern",pattern:a})}}async exists(a){try{let b=await this.redis.exists(a);return 1===b}catch(b){return(0,f.logError)(b,{context:"cache-exists",key:a}),!1}}async ttl(a){try{return await this.redis.ttl(a)}catch(b){return(0,f.logError)(b,{context:"cache-ttl",key:a}),-1}}async increment(a,b=1){try{return await this.redis.incrby(a,b)}catch(b){return(0,f.logError)(b,{context:"cache-increment",key:a}),0}}async hset(a,b,c){try{let d=JSON.stringify(c);await this.redis.hset(a,b,d)}catch(c){(0,f.logError)(c,{context:"cache-hset",key:a,field:b})}}async hget(a,b){try{let c=await this.redis.hget(a,b);if(c)return JSON.parse(c);return null}catch(c){return(0,f.logError)(c,{context:"cache-hget",key:a,field:b}),null}}async hgetall(a){try{let b=await this.redis.hgetall(a),c={};for(let[a,d]of Object.entries(b))try{c[a]=JSON.parse(d)}catch{c[a]=d}return c}catch(b){return(0,f.logError)(b,{context:"cache-hgetall",key:a}),{}}}async clear(){try{await this.redis.flushdb()}catch(a){(0,f.logError)(a,{context:"cache-clear"})}}async getStats(){try{let a=await this.redis.info("memory"),b=await this.redis.dbsize(),c=a.match(/used_memory_human:([^\r\n]+)/),d=c?c[1]:"unknown";return{keys:b,memory:d,connected:"ready"===this.redis.status}}catch(a){return(0,f.logError)(a,{context:"cache-stats"}),{keys:0,memory:"unknown",connected:!1}}}}let k=null;async function l(){return k||(k=new j(await i())),k}let m={NORMAS:"normas",NORMA_DETAIL:"norma:detail",NORMA_STATS:"norma:stats",IA_ANALYSIS:"ia:analysis",IA_ANALYSIS_RESULT:"ia:analysis:result",USER_SESSION:"user:session",API_RATE_LIMIT:"api:rate_limit",HEALTH_CHECK:"health:check"},n={NORMAS:3600,NORMA_DETAIL:7200,NORMA_STATS:1800,IA_ANALYSIS:86400,IA_ANALYSIS_RESULT:604800,USER_SESSION:3600,API_RATE_LIMIT:900,HEALTH_CHECK:60}},96487:()=>{}};