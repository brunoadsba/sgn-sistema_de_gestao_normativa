# Context: Worker Assíncrono (Async Worker)

## Estado Atual (2026-02-23)
A feature foi concluída com sucesso na Sessão 37, utilizando infraestrutura híbrida (Z.AI GLM-4.7) para maior estabilidade e performance.

### Implementação Concluída (Padrão Indústria):
- **API Async**: O endpoint `POST /api/ia/analisar-conformidade` agora retorna `HTTP 202 Accepted` imediatamente com um `jobId`.
- **Background Orchestration**: Utiliza `waitUntil` (se disponível) ou desacoplamento via `Promise` para executar a análise pesada sem prender a conexão.
- **Status API**: Novo endpoint em `GET /api/ia/jobs/[id]` que retorna o status em tempo real, progresso (%) e o resultado final quando concluído.
- **Backward Compatibility**: Adicionado suporte ao parâmetro `?mode=sync` para manter o fluxo síncrono legado se necessário.
- **Tracking Granular**: O worker atualiza os estágios (`extracting`, `analyzing`, `consolidating`) e o progresso numérico no banco de dados.

### Arquitetura:
1. **Request**: Recebe documento -> Cria Job (Status: `pending`) -> Retorna 202.
2. **Worker**: Dispara análise -> Extrai -> Analisa via Provedor (Z.AI) -> Consolida -> Persiste Resultado -> Atualiza Job (Status: `completed`).
3. **Polling**: Frontend consulta o Job -> Exibe progresso -> Redireciona para o resultado final.

### Configurações:
- `maxDuration`: 300s (para garantir tempo de consolidação de documentos grandes).
- `modeloUsado`: Z.AI GLM-4.7 (configurado como fallback do `llama-4-scout` se `AI_PROVIDER` for cloud).

### Próximos Passos:
- Implementar componente de Stepper no Frontend para exibir o progresso visualmente.
- Hardening de segurança nos endpoints de Jobs (Rate limiting e Auth check).
